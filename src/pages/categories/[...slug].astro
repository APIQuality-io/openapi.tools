---
import type { GetStaticPaths } from 'astro';
import { getCollection, getEntry } from 'astro:content';

import PageHeader from '@/components/PageHeader.astro';
import { ToolColumns } from '@/components/table/Columns';
import { DataTable } from '@/components/table/DataTable';
import Layout from '../../layouts/Layout.astro';

// 1. Generate a new path for every collection entry
export const getStaticPaths: GetStaticPaths = async () => {
  const categories = await getCollection('categories');
  return categories.map((category) => ({
    params: { slug: category.slug },
    props: { category },
  }));
};

// 2. For your template, you can get the entry directly from the prop
const { slug } = Astro.params;
const category = await getEntry('categories', slug as string);

if (!category) {
  throw new Error(`No category found for slug ${slug}`);
}

const { Content } = await category.render();

// 3 get entries for this category from the Tools collection
const allTools = await getCollection('tools');

const tools = allTools
  .filter((tool) => {
    if (!tool.data.categories) {
      return false;
    }
    const categories = tool.data.categories;
    // look through the categories list to see if any of the categories matches enry.slug
    return categories.some((cat) => cat.slug === category.slug);
  })
  .sort((a, b) => {
    const checkIsCurrentSponsor = (currentTool: (typeof allTools)[0]) => {
      if (!currentTool.data.sponsorship) {
        return false;
      }
      if (
        !currentTool.data.sponsorship.startDate ||
        !currentTool.data.sponsorship.endDate
      ) {
        return false;
      }
      const startDate = new Date(currentTool.data.sponsorship.startDate);
      const endDate = new Date(currentTool.data.sponsorship.endDate);
      const now = new Date();
      return startDate < now && endDate > now;
    };

    // sponsored tools come first, with the sponsor that started the earliest coming first
    // then sort by name
    const aSponsor = checkIsCurrentSponsor(a);
    const bSponsor = checkIsCurrentSponsor(b);

    if (aSponsor && !bSponsor) {
      return -1;
    }
    if (!aSponsor && bSponsor) {
      return 1;
    }

    const bDate = b.data.sponsorship?.startDate;
    const aDate = a.data.sponsorship?.startDate;
    // both are sponsored, sort by start date
    // note: gross syntax here because TypeScript is not happy with the optional chaining
    if (aSponsor && bSponsor && aDate !== undefined && bDate !== undefined) {
      return new Date(bDate).getTime() - new Date(aDate).getTime();
    }

    return a.data.name.localeCompare(b.data.name);
  });

const toolCount = tools.length;

const toolsData = tools.map((tool) => ({
  category: category.data,
  tool: tool.data,
  slug: tool.slug,
}));
---

<Layout title={category.data.name}>
  <PageHeader
    title={category.data.name}
    description={category.data.description}
  >
    {/* render the body of the markdown file for this category */}
    <div
      class="prose prose-lg dark:prose-invert prose-headings:text-slate-700/90 dark:prose-headings:text-slate-300/90"
    >
      <Content />
    </div>
  </PageHeader>

  <hr class="my-6" />

  <main class="prose-lg w-full dark:prose-invert">
    <h2 class="prose mb-4 text-2xl font-bold">
      {toolCount}
      {category.data.name}
    </h2>
    <section class="prose w-full max-w-none">
      <DataTable data={toolsData} columns={ToolColumns} />
    </section>
  </main>
</Layout>
